<!DOCTYPE html>
<html lang="fa" dir="rtl">
<head>
  <meta charset="UTF-8"/>
  <title>MAi</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"/>
  <link rel="icon" href="MAi.png"/>
  <link rel="stylesheet" href="styles.css"/>
  <!-- Markdown renderer -->
  <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
</head>
<body>

  <!-- ÙØ±Ù… Ù†Ø§Ù… (ÛŒÚ©â€ŒØ¨Ø§Ø± Ù†Ù…Ø§ÛŒØ´) -->
  <div id="name-form" class="overlay">
    <div class="modal">
      <img src="MAi.png" alt="MAi Logo" class="modal-logo"/>
      <h2>Ø®ÙˆØ´ Ø¢Ù…Ø¯ÛŒØ¯!</h2>
      <input type="text" id="name-input" placeholder="Ù†Ø§Ù… Ø®ÙˆØ¯ Ø±Ø§ ÙˆØ§Ø±Ø¯ Ú©Ù†ÛŒØ¯"/>
      <button id="name-submit">Ø´Ø±ÙˆØ¹ Ú©Ù†ÛŒØ¯</button>
    </div>
  </div>

  <!-- Ù‡Ø¯Ø± -->
  <header class="topbar">
    <div class="logo-area">
      <img src="MAi.png" alt="MAi Logo" class="logo"/>
      <span class="site-title">MAi</span>
    </div>
    <div class="tabs">
      <button class="tab-btn active" data-show="chat">Ú†Øª</button>
      <button class="tab-btn" data-show="sessions">Ú¯ÙØªÚ¯ÙˆÙ‡Ø§</button>
      <button class="tab-btn" data-show="settings">ØªÙ†Ø¸ÛŒÙ…Ø§Øª</button>
    </div>
    <div class="user-credit">
      Ø§Ø¹ØªØ¨Ø§Ø±: <span id="credit-display"></span>
    </div>
  </header>

  <!-- Ù†Ù…Ø§ÛŒ Ú†Øª -->
  <main id="chat" class="view">
    <div class="chat-header">
      <label>
        Ù…Ø¯Ù„:
        <select id="model-select">
          <option value="gpt-4o">gpt-4o</option>
          <option value="gemini-2.5-pro">gemini-2.5-pro</option>
        </select>
      </label>
      <button id="new-chat">ğŸ†• Ú†Øª Ø¬Ø¯ÛŒØ¯</button>
    </div>
    <div id="chat-box" class="chat-box" tabindex="0"></div>
    <div class="input-row">
      <textarea id="user-input" placeholder="Ù¾ÛŒØ§Ù… Ø®ÙˆØ¯ Ø±Ø§ Ø¨Ù†ÙˆÛŒØ³ÛŒØ¯â€¦"></textarea>
      <button id="send-btn">â†‘</button>
    </div>
  </main>

  <!-- Ù„ÛŒØ³Øª Ú¯ÙØªÚ¯ÙˆÙ‡Ø§ -->
  <section id="sessions" class="view hidden">
    <h3>Ú¯ÙØªÚ¯ÙˆÙ‡Ø§ÛŒ Ø´Ù…Ø§</h3>
    <div id="sessions-list"></div>
  </section>

  <!-- ØªÙ†Ø¸ÛŒÙ…Ø§Øª -->
  <section id="settings" class="view hidden">
    <h3>ØªÙ†Ø¸ÛŒÙ…Ø§Øª</h3>
    <div class="form-group">
      <label>Ù†Ø§Ù… Ú©Ø§Ø±Ø¨Ø±ÛŒ</label>
      <input id="settings-name" type="text"/>
      <button id="save-name">Ø°Ø®ÛŒØ±Ù‡</button>
    </div>
    <div class="form-group">
      <label>Ø§ÙØ²Ø§ÛŒØ´ Ø§Ø¹ØªØ¨Ø§Ø± / Ú©Ø¯ ØªØ®ÙÛŒÙ</label>
      <input id="promo-input" placeholder="Ú©Ø¯ Ø±Ø§ ÙˆØ§Ø±Ø¯ Ú©Ù†ÛŒØ¯"/>
      <button id="redeem-btn">Ø§Ø¹Ù…Ø§Ù„</button>
    </div>
    <div class="form-group">
      <label>Ú©Ø¯Ù‡Ø§ÛŒ Ø§Ø³ØªÙØ§Ø¯Ù‡â€ŒØ´Ø¯Ù‡</label>
      <ul id="used-codes"></ul>
    </div>
    <button id="clear-all" class="danger">Ø­Ø°Ù Ù‡Ù…Ù‡Ù” Ú¯ÙØªÚ¯ÙˆÙ‡Ø§</button>
  </section>

  <footer class="footer">
    &copy; <span id="year"></span> MAi - All rights reserved.
  </footer>


<script>
(function(){
  const API_URL      = "https://api.gapgpt.app/v1/chat/completions";
  const API_KEY      = "sk-KXYGZrOUDvivO5hmX0yrvCZBUJk1HYB4YuuHSl7C88Beou2Y";
  const INITIAL_CRED = 10;
  const PROMO_MULTI  = ["wh5109sh","37ffjshg","8ehfy6w"];
  const PROMO_UNLIM  = "xallai21001";

  let sessions       = JSON.parse(localStorage.getItem("sessions") || "[]");
  let credits        = JSON.parse(localStorage.getItem("credits") ||
                          JSON.stringify({ remaining: INITIAL_CRED, unlimited: false, used: [] }));
  let currentSession = null;
  let userName       = localStorage.getItem("userName") || "";

  // Ø§Ù„Ù…Ø§Ù†â€ŒÙ‡Ø§
  const nameForm     = document.getElementById("name-form");
  const nameInput    = document.getElementById("name-input");
  const nameSubmit   = document.getElementById("name-submit");
  const tabs         = document.querySelectorAll(".tab-btn");
  const views        = document.querySelectorAll(".view");
  const creditDisp   = document.getElementById("credit-display");
  const chatBox      = document.getElementById("chat-box");
  const userInput    = document.getElementById("user-input");
  const sendBtn      = document.getElementById("send-btn");
  const modelSel     = document.getElementById("model-select");
  const newChatBtn   = document.getElementById("new-chat");
  const sessionsList = document.getElementById("sessions-list");
  const settingsName = document.getElementById("settings-name");
  const saveNameBtn  = document.getElementById("save-name");
  const promoInput   = document.getElementById("promo-input");
  const redeemBtn    = document.getElementById("redeem-btn");
  const usedCodes    = document.getElementById("used-codes");
  const clearAllBtn  = document.getElementById("clear-all");
  const yearSpan     = document.getElementById("year");
  yearSpan.textContent = new Date().getFullYear();

  // Ù†Ù…Ø§ÛŒØ´ ØªØ¨
  tabs.forEach(btn => {
    btn.onclick = () => {
      document.querySelector(".tab-btn.active").classList.remove("active");
      btn.classList.add("active");
      views.forEach(v => {
        if (v.id === btn.dataset.show) v.classList.remove("hidden");
        else v.classList.add("hidden");
      });
      if (btn.dataset.show === "sessions") renderSessions();
      if (btn.dataset.show === "settings") renderSettings();
    };
  });

  // Ø°Ø®ÛŒØ±Ù‡ Ø¯Ø± Ù„ÙˆÚ©Ø§Ù„â€ŒØ§Ø³ØªÙˆØ±ÛŒØ¬
  function persist() {
    localStorage.setItem("sessions", JSON.stringify(sessions));
    localStorage.setItem("credits", JSON.stringify(credits));
    localStorage.setItem("userName", userName);
    if (currentSession) {
      localStorage.setItem("currentSessionId", currentSession.id);
    }
  }

  // Ø¨Ø±ÙˆØ²Ø±Ø³Ø§Ù†ÛŒ Ù†Ù…Ø§ÛŒØ´ Ø§Ø¹ØªØ¨Ø§Ø±
  function updateCredit() {
    creditDisp.textContent = credits.unlimited ? "Ù†Ø§Ù…Ø­Ø¯ÙˆØ¯" : credits.remaining;
    persist();
  }
  updateCredit();

  // Ù†Ù…Ø§ÛŒØ´ Ø®Ø·Ø§ Ø¯Ø± Ú†Øª
  function showError(msg) {
    const el = document.createElement("div");
    el.className = "msg assistant error";
    el.textContent = msg;
    chatBox.appendChild(el);
    scrollToBottom();
  }

  // ÛŒÚ©â€ŒØ¨Ø§Ø± Ù¾Ø±Ø³Ø´ Ù†Ø§Ù…
  function askName() {
    if (userName) return startChat();
    nameForm.classList.add("visible");
  }
  nameSubmit.onclick = () => {
    const v = nameInput.value.trim();
    if (!v) { showError("Ù†Ø§Ù… Ø±Ø§ ÙˆØ§Ø±Ø¯ Ú©Ù†ÛŒØ¯."); return; }
    userName = v;
    localStorage.setItem("userName", userName);
    nameForm.classList.remove("visible");
    startChat();
  };
  askName();

  // Ø´Ø±ÙˆØ¹ ÛŒØ§ Ø¨Ø§Ø±Ú¯Ø°Ø§Ø±ÛŒ Ø³Ø´Ù†
  function startChat() {
    let sid = localStorage.getItem("currentSessionId");
    currentSession = sessions.find(s => s.id === sid);
    if (!currentSession) {
      currentSession = {
        id:     "sess_" + Date.now(),
        name:   userName,
        model:  modelSel.value,
        messages: []
      };
      sessions.push(currentSession);
    }
    modelSel.value = currentSession.model;
    renderMessages();
    persist();
    document.querySelector('[data-show="chat"]').click();
  }

  // Ø±Ù†Ø¯Ø± Ù‡Ù…Ù‡ Ù¾ÛŒØ§Ù…â€ŒÙ‡Ø§
  function renderMessages() {
    chatBox.innerHTML = "";
    currentSession.messages.forEach(msg => {
      appendMessage(msg.role, msg.content);
    });
    scrollToBottom();
  }

  // Ø§Ø¶Ø§ÙÙ‡ Ú©Ø±Ø¯Ù† Ù¾ÛŒØ§Ù… Ø¨Ø§ Ø§ÙÚ©Øª ØªØ§ÛŒÙ¾ Ùˆ Ø±Ù†Ø¯Ø± Markdown
  function appendMessage(sender, message) {
    const messageElem = document.createElement("div");
    const contentContainer = document.createElement("div");
    chatBox.appendChild(messageElem);

    if (sender === "user") {
      messageElem.className = "msg user";
      messageElem.textContent = message;
    } else {
      messageElem.className = "msg assistant";
      messageElem.appendChild(contentContainer);

      let idx = 0;
      const timer = setInterval(() => {
        if (idx < message.length) {
          const slice = message.slice(0, idx + 1);
          contentContainer.innerHTML = marked.parse(slice);
          addCopyButtons(contentContainer);
          scrollToBottom();
          idx++;
        } else {
          clearInterval(timer);
        }
      }, 20);
    }
    scrollToBottom();
  }

  // Ø§ÙØ²ÙˆØ¯Ù† Ø¯Ú©Ù…Ù‡ Ú©Ù¾ÛŒ Ø¨Ù‡ Ø¨Ù„ÙˆÚ©â€ŒÙ‡Ø§ÛŒ Ú©Ø¯
  function addCopyButtons(container) {
    const blocks = container.querySelectorAll("pre");
    blocks.forEach(pre => {
      if (!pre.querySelector(".copy-icon")) {
        const copyBtn = document.createElement("div");
        copyBtn.className = "copy-icon";
        copyBtn.title = "Ú©Ù¾ÛŒ Ú©Ø¯";
        copyBtn.addEventListener("click", () => {
          navigator.clipboard.writeText(pre.innerText);
          copyBtn.style.opacity = "1";
          copyBtn.style.backgroundImage =
            "url('https://dbkhatam.ir/jss/done_FILL0_wght400_GRAD0_opsz24.png')";
          setTimeout(() => {
            copyBtn.style.backgroundImage =
              "url('https://dbkhatam.ir/jss/content_copy_24dp_000000_FILL0_wght400_GRAD0_opsz24.png')";
          }, 1500);
        });
        pre.appendChild(copyBtn);
      }
    });
  }

  // Ø§Ø³Ú©Ø±ÙˆÙ„ Ø¨Ù‡ Ù¾Ø§ÛŒÛŒÙ†
  function scrollToBottom() {
    chatBox.scrollTop = chatBox.scrollHeight;
  }

  // Ø§Ø±Ø³Ø§Ù„ Ù¾ÛŒØ§Ù… Ú©Ø§Ø±Ø¨Ø±
  userInput.addEventListener("keydown", e => {
    if (e.key === "Enter" && !e.shiftKey) {
      e.preventDefault();
      sendMessage();
    }
  });
  sendBtn.onclick = sendMessage;

  function sendMessage() {
    const text = userInput.value.trim();
    if (!text) { showError("Ù…ØªÙ† Ù¾ÛŒØ§Ù… Ù†Ù…ÛŒâ€ŒØªÙˆØ§Ù†Ø¯ Ø®Ø§Ù„ÛŒ Ø¨Ø§Ø´Ø¯."); return; }
    if (!credits.unlimited && credits.remaining <= 0) {
      showError("Ø§Ø¹ØªØ¨Ø§Ø± Ø´Ù…Ø§ Ø¨Ù‡ Ù¾Ø§ÛŒØ§Ù† Ø±Ø³ÛŒØ¯Ù‡."); return;
    }
    if (!credits.unlimited) credits.remaining--;
    updateCredit();

    currentSession.messages.push({ role: "user", content: text });
    persist();
    appendMessage("user", text);
    userInput.value = "";

    const payload = [
      ...currentSession.messages,
      { role: "system", content: `(Ú©Ø§Ø±Ø¨Ø±: ${userName})` }
    ];
    callAPI(payload);
  }

  // ÙØ±Ø§Ø®ÙˆØ§Ù†ÛŒ API
  async function callAPI(msgs) {
    try {
      const res = await fetch(API_URL, {
        method: "POST",
        headers: {
          "Content-Type":  "application/json",
          "Authorization": `Bearer ${API_KEY}`
        },
        body: JSON.stringify({
          model:    modelSel.value,
          messages: msgs
        })
      });
      if (!res.ok) {
        const errText = await res.text();
        throw new Error(`HTTP ${res.status}: ${errText}`);
      }
      const data = await res.json();
      if (data.error) {
        showError(`Ø®Ø·Ø§: ${data.error.message}`); return;
      }
      const ai = data.choices[0].message.content;
      currentSession.messages.push({ role: "assistant", content: ai });
      persist();
      appendMessage("assistant", ai);

    } catch (e) {
      showError("Ø®Ø·Ø§ Ø¯Ø± Ø§Ø±ØªØ¨Ø§Ø· Ø¨Ø§ Ø³Ø±ÙˆØ±.");
      console.error(e);
    }
  }

  // Ú†Øª Ø¬Ø¯ÛŒØ¯
  newChatBtn.onclick = () => {
    localStorage.removeItem("currentSessionId");
    startChat();
  };

  // Ø±Ù†Ø¯Ø± Ø¬Ù„Ø³Ø§Øª
  function renderSessions() {
    sessionsList.innerHTML = "";
    if (!sessions.length) {
      sessionsList.textContent = "Ú¯ÙØªÚ¯ÙˆÛŒÛŒ ÙˆØ¬ÙˆØ¯ Ù†Ø¯Ø§Ø±Ø¯.";
      return;
    }
    sessions.forEach(s => {
      const row = document.createElement("div");
      row.className = "session-row";
      row.innerHTML = `
        <span>${s.name} â€“ ${s.id.slice(-6)}</span>
        <div>
          <button class="btn small resume" data-id="${s.id}">Ø§Ø¯Ø§Ù…Ù‡</button>
          <button class="btn small del" data-id="${s.id}">Ø­Ø°Ù</button>
        </div>`;
      sessionsList.appendChild(row);
    });
    sessionsList.querySelectorAll(".resume").forEach(b => {
      b.onclick = () => {
        localStorage.setItem("currentSessionId", b.dataset.id);
        startChat();
      };
    });
    sessionsList.querySelectorAll(".del").forEach(b => {
      b.onclick = () => {
        sessions = sessions.filter(s => s.id !== b.dataset.id);
        persist();
        renderSessions();
      };
    });
  }

  // Ø±Ù†Ø¯Ø± ØªÙ†Ø¸ÛŒÙ…Ø§Øª
  function renderSettings() {
    settingsName.value = userName;
    usedCodes.innerHTML = "";
    credits.used.forEach(c => {
      const li = document.createElement("li");
      li.textContent = c + " ";
      const btn = document.createElement("button");
      btn.textContent = "âŒ"; btn.className = "small";
      btn.onclick = () => {
        credits.used = credits.used.filter(x => x !== c);
        if (c === PROMO_UNLIM) credits.unlimited = false;
        else if (PROMO_MULTI.includes(c)) credits.remaining -= 50;
        updateCredit();
        renderSettings();
      };
      li.appendChild(btn);
      usedCodes.appendChild(li);
    });
  }

  // Ø°Ø®ÛŒØ±Ù‡ Ù†Ø§Ù…
  saveNameBtn.onclick = () => {
    const v = settingsName.value.trim();
    if (!v) { showError("Ù†Ø§Ù… Ù†Ù…ÛŒâ€ŒØªÙˆØ§Ù†Ø¯ Ø®Ø§Ù„ÛŒ Ø¨Ø§Ø´Ø¯."); return; }
    userName = v; persist(); showError("Ù†Ø§Ù… Ø°Ø®ÛŒØ±Ù‡ Ø´Ø¯.");
  };

  // Ø§Ø¹Ù…Ø§Ù„ Ú©Ø¯ ØªØ®ÙÛŒÙ
  redeemBtn.onclick = () => {
    const code = promoInput.value.trim();
    if (!code) { showError("Ú©Ø¯ Ø±Ø§ ÙˆØ§Ø±Ø¯ Ú©Ù†ÛŒØ¯."); return; }
    if (credits.used.includes(code)) {
      showError("Ø§ÛŒÙ† Ú©Ø¯ Ù‚Ø¨Ù„Ø§Ù‹ Ø§Ø³ØªÙØ§Ø¯Ù‡ Ø´Ø¯Ù‡."); return;
    }
    if (code === PROMO_UNLIM) credits.unlimited = true;
    else if (PROMO_MULTI.includes(code)) credits.remaining += 50;
    else { showError("Ú©Ø¯ Ù†Ø§Ù…Ø¹ØªØ¨Ø± Ø§Ø³Øª."); return; }
    credits.used.push(code);
    updateCredit(); renderSettings();
    promoInput.value = "";
    showError("Ú©Ø¯ Ø¨Ø§ Ù…ÙˆÙÙ‚ÛŒØª Ø§Ø¹Ù…Ø§Ù„ Ø´Ø¯.");
  };

  // Ø­Ø°Ù Ù‡Ù…Ù‡ Ú¯ÙØªÚ¯ÙˆÙ‡Ø§ (Ø§Ø¹ØªØ¨Ø§Ø± Ùˆ Ù†Ø§Ù… Ø¨Ø§Ù‚ÛŒ Ø¨Ù…Ø§Ù†Ø¯)
  clearAllBtn.onclick = () => {
    if (!confirm("Ù‡Ù…Ù‡Ù” Ú¯ÙØªÚ¯ÙˆÙ‡Ø§ Ù¾Ø§Ú© Ø´ÙˆØ¯ØŸ")) return;
    localStorage.removeItem("sessions");
    localStorage.removeItem("currentSessionId");
    sessions = [];
    currentSession = null;
    document.querySelector('[data-show="chat"]').click();
    renderMessages();
  };

})();
</script>

</body>
</html>
