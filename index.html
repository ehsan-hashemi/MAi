<!DOCTYPE html>
<html lang="fa" dir="rtl">
<head>
  <meta charset="UTF-8"/>
  <title>MAi</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"/>
  <link rel="icon" href="/MAI.png"/>
  <link rel="stylesheet" href="styles.css"/>
  <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
</head>
<body>

  <div id="name-form" class="overlay">
    <div class="modal">
      <img src="/MAI.png" alt="MAi Logo" class="modal-logo"/>
      <h2>خوش آمدید!</h2>
      <input type="text" id="name-input" placeholder="نام خود را وارد کنید"/>
      <button id="name-submit">شروع کنید</button>
    </div>
  </div>

  <header class="topbar">
    <div class="logo-area">
      <img src="/MAI.png" alt="MAi Logo" class="logo"/>
      <span class="site-title">MAi</span>
    </div>
    <div class="tabs">
      <button class="tab-btn active" data-show="chat">چت</button>
      <button class="tab-btn" data-show="sessions">گفتگوها</button>
      <button class="tab-btn" data-show="settings">تنظیمات</button>
      <button class="tab-btn" data-show="Made">سازنده</button>
    </div>
    <div class="user-credit">
      اعتبار: <span id="credit-display"></span>
    </div>
  </header>

  <main id="chat" class="view">
    <p>چک کنید حتما با https وارد شده باشید.</p>
    <br>
    <div id="chat-box" class="chat-box" tabindex="0"></div>
    <div class="input-row">
      <textarea id="user-input" placeholder="پیام خود را بنویسید…"></textarea>
      <button id="send-btn" onclick="sendMessage()">↑</button>
    </div>
  </main>

  <section id="sessions" class="view hidden">
   <div class="chat-header">
      <label>
        مدل:
        <select class="selectai" id="model-select">
          <option value="gpt-4o">gpt-4o</option>
          <option value="gemini-2.5-pro">gemini-2.5-pro</option>
          <option value="deepseek-chat">deepseek-chat</option>
          <option value="grok-4">grok-4</option>
        </select>
      </label>
      <button id="new-chat">چت جدید</button>
    </div> 
    <h3>گفتگوهای شما</h3>
    <p>گفتگو های جدیدتر پایین تر هستند!</p>
    <br>
    <div id="sessions-list"></div>
  </section>

  <section id="settings" class="view hidden">
    <h3>تنظیمات</h3>
    <div class="form-group">
      <label>نام کاربری</label>
      <input id="settings-name" type="text"/>
      <button id="save-name">ذخیره</button>
    </div>
    <div class="form-group">
      <label>کد تخفیف / افزایش اعتبار</label>
      <input id="promo-input" placeholder="کد را وارد کنید"/>
      <button id="redeem-btn">اعمال</button>
    </div>
    <div class="form-group">
      <label>کدهای استفاده‌شده</label>
      <ul id="used-codes"></ul>
    </div>
    <button id="clear-all" class="danger">حذف همهٔ گفتگوها</button>
  </section>

  <section id="Made" class="view hidden">
    <h3>سازنده</h3>
    <p>سازنده‌ی MAi گروه برنامه نویسی احسان است.</p>
    <a href="https://ehsan-hashemi.ir">ehsan-hashemi.ir</a>
    <br>
    <p>با حمایت از ما در بهبود کیفیت سایت کمک کنید.</p>
    <br>
    <div style="text-align:center;">
      <a href="http://www.coffeete.ir/Ehsan_Programming_Group">
        <img src="/lemonchiffon.png" style="width:260px;" />
      </a>
    </div>
  </section>

  <footer class="footer">
    <p style="direction:ltr">
      &copy; <span id="year"></span> Enter Code - All rights reserved. <a href="https://ehsan-hashemi.ir/">Ehsan Group</a>
    </p>
  </footer>

  <script>
(function() {
  const API_URL     = "https://api.gapgpt.app/v1/chat/completions";
  const API_KEY     = "sk-XVUuKiSZQMmkutogcsjjLFcKpwL6lbo0X2Gr77mNwSzjTZhJ";
  const INITIAL_C   = 8;
  const PROMO_MULTI = ["wh5109sh", "37ffjshg", "8ehfy6w"];
  const PROMO_UNLIM = "xallai21001";
  const COPY_ICON   = "https://dbkhatam.ir/jss/content_copy_24dp_000000_FILL0_wght400_GRAD0_opsz24.png";

  let sessions = JSON.parse(localStorage.getItem("sessions") || "[]");
  let credits  = JSON.parse(localStorage.getItem("credits") ||
                  JSON.stringify({ remaining: INITIAL_C, unlimited: false, used: [] }));
  let currentSession, userName = localStorage.getItem("userName") || "";
  let abortCtrl = null, isStreaming = false;

  const elems = {
    nameForm:     document.getElementById("name-form"),
    nameInput:    document.getElementById("name-input"),
    nameSubmit:   document.getElementById("name-submit"),
    tabs:         document.querySelectorAll(".tab-btn"),
    views:        document.querySelectorAll(".view"),
    creditDisp:   document.getElementById("credit-display"),
    chatBox:      document.getElementById("chat-box"),
    userInput:    document.getElementById("user-input"),
    sendBtn:      document.getElementById("send-btn"),
    modelSel:     document.getElementById("model-select"),
    newChatBtn:   document.getElementById("new-chat"),
    sessionsList: document.getElementById("sessions-list"),
    settingsName: document.getElementById("settings-name"),
    saveNameBtn:  document.getElementById("save-name"),
    promoInput:   document.getElementById("promo-input"),
    redeemBtn:    document.getElementById("redeem-btn"),
    usedCodes:    document.getElementById("used-codes"),
    clearAllBtn:  document.getElementById("clear-all"),
    yearSpan:     document.getElementById("year")
  };

  // ————— افزودن هوشمندی رفتار Enter در دسکتاپ/موبایل —————

  // تشخیص موبایل
  function isMobile() {
    return /Android|iPhone|iPad|iPod/i.test(navigator.userAgent);
  }

  // هندلر keydown برای textarea
  function handleKey(event) {
    if (event.key === 'Enter') {
      if (isMobile()) {
        // موبایل: همیشه خط جدید
        return;
      } else {
        // دسکتاپ: Shift+Enter سطر جدید، Enter ساده ارسال
        if (event.shiftKey) {
          return;
        } else {
          event.preventDefault();
          sendMessage();
        }
      }
    }
  }

  // متصل کردن هندلر
  elems.userInput.addEventListener('keydown', handleKey);

  elems.sendBtn.onclick = sendMessage;

  // ——————————————————————————————————————————————

  elems.yearSpan.textContent = new Date().getFullYear();

  elems.tabs.forEach(btn => {
    btn.onclick = () => {
      document.querySelector(".tab-btn.active").classList.remove("active");
      btn.classList.add("active");
      elems.views.forEach(v => {
        v.id === btn.dataset.show
          ? v.classList.remove("hidden")
          : v.classList.add("hidden");
      });
      if (btn.dataset.show === "sessions") renderSessions();
      if (btn.dataset.show === "settings") renderSettings();
    };
  });

  function persist() {
    localStorage.setItem("sessions", JSON.stringify(sessions));
    localStorage.setItem("credits", JSON.stringify(credits));
    localStorage.setItem("userName", userName);
    if (currentSession) {
      localStorage.setItem("currentSessionId", currentSession.id);
    }
  }

  function updateCredit() {
    elems.creditDisp.textContent = credits.unlimited ? "نامحدود" : credits.remaining;
    persist();
  }

  function scrollOnce() {
    requestAnimationFrame(() => {
      elems.chatBox.scrollTop = elems.chatBox.scrollHeight;
    });
  }

  function appendUser(text) {
    const d = document.createElement("div");
    d.className = "msg user";
    d.textContent = text;
    elems.chatBox.appendChild(d);
    return d;
  }

  function appendAssist() {
    const d = document.createElement("div");
    d.className = "msg assistant";
    elems.chatBox.appendChild(d);
    return d;
  }

  function addCopyButtons(container) {
    container.querySelectorAll("pre code").forEach(codeBlock => {
      const pre = codeBlock.parentElement;
      const wrapper = document.createElement("div");
      wrapper.style.position = "relative";
      pre.parentNode.replaceChild(wrapper, pre);
      wrapper.appendChild(pre);
      const btn = document.createElement("img");
      btn.src = COPY_ICON;
      btn.title = "کپی کد";
      btn.style.cssText = "position:absolute;top:4px;left:4px;cursor:pointer;width:24px;";
      btn.onclick = () => navigator.clipboard.writeText(codeBlock.textContent);
      wrapper.appendChild(btn);
    });
  }

  function showError(msg) {
    const d = appendAssist();
    d.textContent = msg;
    scrollOnce();
  }

  function setStreaming(on) {
    isStreaming = on;
    elems.sendBtn.textContent = on ? "■" : "↑";
    elems.sendBtn.onclick = on ? () => abortCtrl?.abort() : sendMessage;
  }

  async function sendMessage() {
    const txt = elems.userInput.value.trim();
    if (!txt) return showError("متن پیام نمی‌تواند خالی باشد.");
    if (!credits.unlimited && credits.remaining < 1)
      return showError("اعتبار شما به پایان رسیده.");
    if (!credits.unlimited) credits.remaining--;
    updateCredit();

    currentSession.messages.push({ role: "user", content: txt });
    persist();
    appendUser(txt);
    scrollOnce();
    elems.userInput.value = "";

    await callAPI();
  }

  async function callAPI() {
    setStreaming(true);
    abortCtrl = new AbortController();

    const modelIdentity = currentSession.model === "gpt-4o"
      ? "شما مدل gpt-4o هستید."
      : "شما مدل gemini-2.5-pro هستید.";
    const sys1 = { role: "system", content: modelIdentity };
    const sys2 = { role: "system", content: `(کاربر: ${userName})` };
    const messages = [sys1, sys2, ...currentSession.messages];

    let assistantText = "";
    const assistEl = appendAssist();
    scrollOnce();

    try {
      const res = await fetch(API_URL, {
        method: "POST",
        headers: {
          "Content-Type": "application/json",
          "Authorization": `Bearer ${API_KEY}`
        },
        body: JSON.stringify({
          model: currentSession.model,
          messages,
          stream: true
        }),
        signal: abortCtrl.signal
      });
      if (!res.ok) throw new Error(`HTTP ${res.status}`);

      const reader  = res.body.getReader();
      const decoder = new TextDecoder();

      while (true) {
        const { done, value } = await reader.read();
        if (done) break;
        const chunk = decoder.decode(value, { stream: true });
        chunk.split("\n")
          .filter(l => l.startsWith("data:"))
          .forEach(line => {
            const j = line.replace("data:", "").trim();
            if (j === "[DONE]") return;
            try {
              const p = JSON.parse(j);
              const c = p.choices?.[0]?.delta?.content;
              if (c) assistantText += c;
            } catch {}
          });
        assistEl.innerHTML = marked.parse(assistantText);
      }

      currentSession.messages.push({ role: "assistant", content: assistantText });
      persist();
      addCopyButtons(assistEl);

    } catch (e) {
      if (e.name !== "AbortError") showError("خطا در ارتباط با سرور.");
    } finally {
      setStreaming(false);
      abortCtrl = null;
      scrollOnce();
    }
  }

  elems.modelSel.onchange = () => {
    if (currentSession) {
      currentSession.model = elems.modelSel.value;
      persist();
    }
  };

  function askName() {
    if (userName) return startChat();
    elems.nameForm.classList.add("visible");
  }

  elems.nameSubmit.onclick = () => {
    const v = elems.nameInput.value.trim();
    if (!v) return showError("نام را وارد کنید.");
    userName = v;
    persist();
    elems.nameForm.classList.remove("visible");
    startChat();
  };

  function startChat() {
    const sid = localStorage.getItem("currentSessionId");
    currentSession = sessions.find(s => s.id === sid) || null;
    if (!currentSession) {
      currentSession = {
        id: Date.now().toString(),
        name: userName,
        model: elems.modelSel.value,
        messages: []
      };
      sessions.push(currentSession);
    }
    elems.modelSel.value = currentSession.model;
    renderMessages();
    persist();
    document.querySelector('[data-show="chat"]').click();
  }

  function renderMessages() {
    elems.chatBox.innerHTML = "";
    currentSession.messages.forEach(m => {
      if (m.role === "user") {
        appendUser(m.content);
      } else {
        const el = appendAssist();
        el.innerHTML = marked.parse(m.content);
        addCopyButtons(el);
      }
    });
    scrollOnce();
  }

  elems.newChatBtn.onclick = () => {
    localStorage.removeItem("currentSessionId");
    startChat();
  };

  function renderSessions() {
    elems.sessionsList.innerHTML = "";
    if (!sessions.length) {
      elems.sessionsList.textContent = "گفتگویی وجود ندارد.";
      return;
    }
    sessions.forEach(s => {
      const row = document.createElement("div");
      row.className = "session-row";
      row.innerHTML = `
        <span>${s.name} – ${s.id.slice(-6)}</span>
        <div>
          <button class="btn small resume" data-id="${s.id}">ادامه</button>
          <button class="btn small del"    data-id="${s.id}">حذف</button>
        </div>`;
      elems.sessionsList.appendChild(row);
    });
    elems.sessionsList.querySelectorAll(".resume").forEach(btn => {
      btn.onclick = () => {
        localStorage.setItem("currentSessionId", btn.dataset.id);
        startChat();
      };
    });
    elems.sessionsList.querySelectorAll(".del").forEach(btn => {
      btn.onclick = () => {
        sessions = sessions.filter(s => s.id !== btn.dataset.id);
        persist();
        renderSessions();
      };
    });
  }

  function renderSettings() {
    elems.settingsName.value = userName;
    elems.usedCodes.innerHTML = "";
    credits.used.forEach(code => {
      const li = document.createElement("li");
      li.textContent = code + " ";
      const b = document.createElement("button");
      b.textContent = "❌";
      b.className = "small";
      b.onclick = () => {
        credits.used = credits.used.filter(c => c !== code);
        if (code === PROMO_UNLIM) credits.unlimited = false;
        else if (PROMO_MULTI.includes(code)) credits.remaining -= 50;
        updateCredit();
        renderSettings();
      };
      li.appendChild(b);
      elems.usedCodes.appendChild(li);
    });
  }

  elems.saveNameBtn.onclick = () => {
    const v = elems.settingsName.value.trim();
    if (!v) return showError("نام نمی‌تواند خالی باشد.");
    userName = v;
    persist();
    showError("نام ذخیره شد.");
  };

  elems.redeemBtn.onclick = () => {
    const c = elems.promoInput.value.trim();
    if (!c) return showError("کد را وارد کنید.");
    if (credits.used.includes(c)) return showError("این کد قبلاً استفاده شده.");
    if (c === PROMO_UNLIM) credits.unlimited = true;
    else if (PROMO_MULTI.includes(c)) credits.remaining += 50;
    else return showError("کد نامعتبر است.");
    credits.used.push(c);
    updateCredit();
    renderSettings();
    elems.promoInput.value = "";
    showError("کد با موفقیت اعمال شد.");
  };

  elems.clearAllBtn.onclick = () => {
    if (!confirm("همهٔ گفتگوها پاک شود؟")) return;
    localStorage.removeItem("sessions");
    localStorage.removeItem("currentSessionId");
    sessions = [];
    currentSession = null;
    document.querySelector('[data-show="chat"]').click();
    elems.chatBox.innerHTML = "";
  };

  function init() {
    updateCredit();
    askName();
  }

  init();
})();
</script>
</body>
</html>