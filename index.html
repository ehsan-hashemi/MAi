<!DOCTYPE html>
<html lang="fa" dir="rtl">
<head>
  <meta charset="UTF-8"/>
  <title>MAi</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"/>
  <link rel="icon" href="/MAI.png"/>
  <link rel="stylesheet" href="styles.css"/>
  <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
</head>
<body>

  <div id="name-form" class="overlay">
    <div class="modal">
      <img src="/MAI.png" alt="MAi Logo" class="modal-logo"/>
      <h2>خوش آمدید!</h2>
      <input type="text" id="name-input" placeholder="نام خود را وارد کنید"/>
      <button id="name-submit">شروع کنید</button>
    </div>
  </div>

  <header class="topbar">
    <div class="logo-area">
      <img src="/MAI.png" alt="MAi Logo" class="logo"/>
      <span class="site-title">MAi</span>
    </div>
    <div class="tabs">
      <button class="tab-btn active" data-show="chat">چت</button>
      <button class="tab-btn" data-show="sessions">گفتگوها</button>
      <button class="tab-btn" data-show="settings">تنظیمات</button>
      <a class="tab-btn" href="https://ehsan-hashemi.ir">سازنده</a>
    </div>
    <div class="user-credit">
      اعتبار: <span id="credit-display"></span>
    </div>
  </header>

  <main id="chat" class="view">
    <div class="chat-header">
      <label>
        مدل:
        <select id="model-select">
          <option value="gpt-4o">gpt-4o</option>
          <option value="gemini-2.5-pro">gemini-2.5-pro</option>
        </select>
      </label>
      <button id="new-chat">چت جدید</button>
    </div>
    <div id="chat-box" class="chat-box" tabindex="0"></div>
    <div class="input-row">
      <textarea id="user-input" placeholder="پیام خود را بنویسید…"></textarea>
      <button id="send-btn">↑</button>
    </div>
  </main>

  <section id="sessions" class="view hidden">
    <h3>گفتگوهای شما</h3>
    <div id="sessions-list"></div>
  </section>

  <section id="settings" class="view hidden">
    <h3>تنظیمات</h3>
    <div class="form-group">
      <label>نام کاربری</label>
      <input id="settings-name" type="text"/>
      <button id="save-name">ذخیره</button>
    </div>
    <div class="form-group">
      <label>افزایش اعتبار / کد تخفیف</label>
      <input id="promo-input" placeholder="کد را وارد کنید"/>
      <button id="redeem-btn">اعمال</button>
    </div>
    <div class="form-group">
      <label>کدهای استفاده‌شده</label>
      <ul id="used-codes"></ul>
    </div>
    <button id="clear-all" class="danger">حذف همهٔ گفتگوها</button>
  </section>

  <footer class="footer">
    <p style="direction: ltr">
      &copy; <span id="year">2025</span> Enter Code - All rights reserved.
      <a href="https://ehsan-hashemi.ir" target="_blank">Ehsan Group</a>
    </p>
  </footer>

  <script>
  (function(){
    const API_URL      = "https://api.gapgpt.app/v1/chat/completions";
    const API_KEY      = "sk-KXYGZrOUDvivO5hmX0yrvCZBUJk1HYB4YuuHSl7C88Beou2Y";
    const INITIAL_CRED = 10;
    const PROMO_MULTI  = ["wh5109sh","37ffjshg","8ehfy6w"];
    const PROMO_UNLIM  = "xallai21001";

    let sessions       = JSON.parse(localStorage.getItem("sessions") || "[]");
    let credits        = JSON.parse(localStorage.getItem("credits") ||
                            JSON.stringify({ remaining: INITIAL_CRED, unlimited: false, used: [] }));
    let currentSession = null;
    let userName       = localStorage.getItem("userName") || "";

    const nameForm     = document.getElementById("name-form");
    const nameInput    = document.getElementById("name-input");
    const nameSubmit   = document.getElementById("name-submit");
    const tabs         = document.querySelectorAll(".tab-btn");
    const views        = document.querySelectorAll(".view");
    const creditDisp   = document.getElementById("credit-display");
    const chatBox      = document.getElementById("chat-box");
    const userInput    = document.getElementById("user-input");
    const sendBtn      = document.getElementById("send-btn");
    const modelSel     = document.getElementById("model-select");
    const newChatBtn   = document.getElementById("new-chat");
    const sessionsList = document.getElementById("sessions-list");
    const settingsName = document.getElementById("settings-name");
    const saveNameBtn  = document.getElementById("save-name");
    const promoInput   = document.getElementById("promo-input");
    const redeemBtn    = document.getElementById("redeem-btn");
    const usedCodes    = document.getElementById("used-codes");
    const clearAllBtn  = document.getElementById("clear-all");
    const yearSpan     = document.getElementById("year");
    yearSpan.textContent = new Date().getFullYear();

    // نمایش تب‌ها
    tabs.forEach(btn => {
      btn.onclick = () => {
        document.querySelector(".tab-btn.active").classList.remove("active");
        btn.classList.add("active");
        views.forEach(v => {
          v.id === btn.dataset.show
            ? v.classList.remove("hidden")
            : v.classList.add("hidden");
        });
        if (btn.dataset.show === "sessions") renderSessions();
        if (btn.dataset.show === "settings") renderSettings();
      };
    });

    function persist() {
      localStorage.setItem("sessions", JSON.stringify(sessions));
      localStorage.setItem("credits", JSON.stringify(credits));
      localStorage.setItem("userName", userName);
      if (currentSession) {
        localStorage.setItem("currentSessionId", currentSession.id);
      }
    }

    function updateCredit() {
      creditDisp.textContent = credits.unlimited ? "نامحدود" : credits.remaining;
      persist();
    }
    updateCredit();

    function showError(msg) {
      const el = document.createElement("div");
      el.className = "msg assistant error";
      el.textContent = msg;
      chatBox.appendChild(el);
      scrollToBottom();
    }

    function askName() {
      if (userName) return startChat();
      nameForm.classList.add("visible");
    }
    nameSubmit.onclick = () => {
      const v = nameInput.value.trim();
      if (!v) { showError("نام را وارد کنید."); return; }
      userName = v;
      persist();
      nameForm.classList.remove("visible");
      startChat();
    };
    askName();

    function startChat() {
      const sid = localStorage.getItem("currentSessionId");
      currentSession = sessions.find(s => s.id === sid);
      if (!currentSession) {
        currentSession = {
          id: Date.now().toString(),
          name: userName,
          model: modelSel.value,
          messages: []
        };
        sessions.push(currentSession);
      }
      modelSel.value = currentSession.model;
      renderMessages();
      persist();
      document.querySelector('[data-show="chat"]').click();
    }

    function renderMessages() {
      chatBox.innerHTML = "";
      currentSession.messages.forEach(msg => {
        appendMessage(msg.role, msg.content, false);
      });
      scrollToBottom();
    }

    function appendMessage(sender, message, typing = false) {
      const el = document.createElement("div");
      el.className = "msg " + (sender === "user" ? "user" : "assistant");
      chatBox.appendChild(el);

      if (sender === "assistant" && typing) {
        let idx = 0;
        const timer = setInterval(() => {
          el.textContent += message[idx++] || "";
          scrollToBottom();
          if (idx >= message.length) clearInterval(timer);
        }, 20);
      } else {
        el.textContent = message;
        scrollToBottom();
      }
    }

    function scrollToBottom() {
      chatBox.scrollTop = chatBox.scrollHeight;
    }

    userInput.addEventListener("keydown", e => {
      if (e.key === "Enter" && !e.shiftKey) {
        e.preventDefault();
        sendMessage();
      }
    });
    sendBtn.onclick = sendMessage;

    function sendMessage() {
      const text = userInput.value.trim();
      if (!text) { showError("متن پیام نمی‌تواند خالی باشد."); return; }
      if (!credits.unlimited && credits.remaining <= 0) {
        showError("اعتبار شما به پایان رسیده."); return;
      }
      if (!credits.unlimited) credits.remaining--;
      updateCredit();

      currentSession.messages.push({ role: "user", content: text });
      persist();
      appendMessage("user", text, false);
      userInput.value = "";

      const payload = [
        ...currentSession.messages,
        { role: "system", content: `(کاربر: ${userName})` }
      ];
      callAPI(payload);
    }

    async function callAPI(msgs) {
      try {
        const res = await fetch(API_URL, {
          method: "POST",
          headers: {
            "Content-Type":  "application/json",
            "Authorization": `Bearer ${API_KEY}`
          },
          body: JSON.stringify({
            model:    modelSel.value,
            messages: msgs
          })
        });
        if (!res.ok) throw new Error(`HTTP ${res.status}`);

        const data = await res.json();
        if (data.error) {
          showError(`خطا: ${data.error.message}`); 
          return;
        }

        const ai = data.choices[0].message.content;
        currentSession.messages.push({ role: "assistant", content: ai });
        persist();
        appendMessage("assistant", ai, true);

      } catch (e) {
        console.error(e);
        showError("خطا در ارتباط با سرور.");
      }
    }

    newChatBtn.onclick = () => {
      localStorage.removeItem("currentSessionId");
      startChat();
    };

    function renderSessions() {
      sessionsList.innerHTML = "";
      if (!sessions.length) {
        sessionsList.textContent = "گفتگویی وجود ندارد.";
        return;
      }
      sessions.forEach(s => {
        const row = document.createElement("div");
        row.className = "session-row";
        row.innerHTML = `
          <span>${s.name} – ${s.id.slice(-6)}</span>
          <div>
            <button class="btn small resume" data-id="${s.id}">ادامه</button>
            <button class="btn small del" data-id="${s.id}">حذف</button>
          </div>`;
        sessionsList.appendChild(row);
      });
      sessionsList.querySelectorAll(".resume").forEach(b => {
        b.onclick = () => {
          localStorage.setItem("currentSessionId", b.dataset.id);
          startChat();
        };
      });
      sessionsList.querySelectorAll(".del").forEach(b => {
        b.onclick = () => {
          sessions = sessions.filter(x => x.id !== b.dataset.id);
          persist();
          renderSessions();
        };
      });
    }

    function renderSettings() {
      settingsName.value = userName;
      usedCodes.innerHTML = "";
      credits.used.forEach(code => {
        const li = document.createElement("li");
        li.textContent = code + " ";
        const btn = document.createElement("button");
        btn.textContent = "❌"; btn.className = "small";
        btn.onclick = () => {
          credits.used = credits.used.filter(x => x !== code);
          if (code === PROMO_UNLIM) credits.unlimited = false;
          else if (PROMO_MULTI.includes(code)) credits.remaining -= 50;
          updateCredit();
          renderSettings();
        };
        li.appendChild(btn);
        usedCodes.appendChild(li);
      });
    }

    saveNameBtn.onclick = () => {
      const v = settingsName.value.trim();
      if (!v) { showError("نام نمی‌تواند خالی باشد."); return; }
      userName = v; persist(); showError("نام ذخیره شد.");
    };

    redeemBtn.onclick = () => {
      const code = promoInput.value.trim();
      if (!code) { showError("کد را وارد کنید."); return; }
      if (credits.used.includes(code)) {
        showError("این کد قبلاً استفاده شده."); return;
      }
      if (code === PROMO_UNLIM) credits.unlimited = true;
      else if (PROMO_MULTI.includes(code)) credits.remaining += 50;
      else { showError("کد نامعتبر است."); return; }
      credits.used.push(code);
      updateCredit();
      renderSettings();
      promoInput.value = "";
      showError("کد با موفقیت اعمال شد.");
    };

    clearAllBtn.onclick = () => {
      if (!confirm("همهٔ گفتگوها پاک شود؟")) return;
      localStorage.removeItem("sessions");
      localStorage.removeItem("currentSessionId");
      sessions = [];
      currentSession = null;
      document.querySelector('[data-show="chat"]').click();
      renderMessages();
    };

  })();
  </script>
</body>
</html>
