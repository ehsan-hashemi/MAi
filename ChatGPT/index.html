<!DOCTYPE html>
<html lang="fa" dir="rtl">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>MAi – Chat GPT</title>
  <link rel="icon" href="/MAI.png"/>
  <link rel="stylesheet" href="/styles.css"/>
  <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
</head>
<body>
  <!-- Navbar -->
  <div class="navbar0">MAi</div>
  <div class="navbar1">Chat GPT</div>
  <div class="navbar2">
    <a href="/">خانه</a> |
    <a href="/sessions.html">گفتگوها</a> |
    <a href="/settings.html">تنظیمات</a>
  </div>

  <!-- فرم نام کاربر -->
  <div id="name-form" class="chat-container" style="text-align:center;">
    <h2>نام خود را وارد کنید</h2>
    <input type="text" id="name-input" placeholder="مثلاً احسان" />
    <br/><br/>
    <button class="send-button" onclick="saveName()">شروع</button>
  </div>

  <!-- بخش چت -->
  <div id="chat-section" class="chat-container" style="display:none;">
    <div id="chat-box"></div>
    <div class="input-container">
      <textarea id="user-input" placeholder="پیام خود را بنویسید..."></textarea>
      <button class="send-button" onclick="sendMessage()">
        <i class="arrow-up"></i>
      </button>
    </div>
  </div>

  <footer class="footer">
    &copy; <span id="year"></span> MAi – All rights reserved.
    <a href="https://ehsan-hashemi.ir" target="_blank">Ehsan Group</a>
  </footer>

  <script>
    document.getElementById("year").textContent = new Date().getFullYear();

    // ذخیره یا لود نام
    function saveName() {
      const v = document.getElementById("name-input").value.trim();
      if (!v) return alert("لطفاً نام را وارد کنید.");
      localStorage.setItem("userName", v);
      location.reload();
    }
    const userName = localStorage.getItem("userName");
    if (userName) {
      document.getElementById("name-form").style.display = "none";
      document.getElementById("chat-section").style.display = "block";
    }

    // لود سشن
    const params = new URLSearchParams(window.location.search);
    let sessionId = params.get("sessionId");
    const sessions = JSON.parse(localStorage.getItem("chatSessions")||"[]");
    let current = sessions.find(s=>s.id===sessionId);
    if (!current) {
      sessionId = "session_"+Date.now();
      current = {
        id: sessionId,
        name: userName,
        created: new Date().toLocaleString("fa-IR"),
        messages: []
      };
      sessions.push(current);
      localStorage.setItem("chatSessions", JSON.stringify(sessions));
      history.replaceState(null,"",`?sessionId=${sessionId}`);
    }

    const apiUrl = "https://api.gapgpt.app/v1/chat/completions";
    const apiKey = "sk-XXX";  // کلید خودتو بذار
    const weekDays = ["یکشنبه","دوشنبه","سه‌شنبه","چهارشنبه","پنجشنبه","جمعه","شنبه"];

    // تایپ افکت
    function typeEffect(container, text, cb) {
      let i=0;
      const interval = setInterval(()=>{
        container.innerHTML = marked.parse(text.slice(0, i+1));
        container.parentElement.scrollIntoView({behavior:"smooth"});
        i++;
        if(i>=text.length) {
          clearInterval(interval);
          if(cb) cb();
        }
      }, 20);
    }

    function appendMessage(who, text) {
      const box = document.getElementById("chat-box");
      const div = document.createElement("div");
      div.className = who==="user"?"message user-message":"message bot-message";
      if (who==="bot") {
        const inner = document.createElement("div");
        div.appendChild(inner);
        typeEffect(inner, text);
      } else {
        div.innerText = text;
        div.style.opacity = 1;
      }
      box.appendChild(div);
      box.scrollTop = box.scrollHeight;
    }

    // رندر تاریخچه
    current.messages.forEach(m=>{
      appendMessage(m.role==="assistant"?"bot":"user", m.content);
    });

    // ارسال پیام
    async function sendMessage() {
      const ta = document.getElementById("user-input");
      const txt = ta.value.trim();
      if (!txt) return;
      const now = new Date();
      const faDate = now.toLocaleString("fa-IR");
      const day = weekDays[now.getDay()];

      // ثبت کاربر
      current.messages.push({role:"user",content:txt,timestamp:faDate});
      if(current.messages.length>50) current.messages.shift();
      localStorage.setItem("chatSessions",JSON.stringify(sessions));
      appendMessage("user",txt);
      ta.value="";

      const res = await fetch(apiUrl,{
        method:"POST",
        headers:{
          "Content-Type":"application/json",
          Authorization:`Bearer ${apiKey}`
        },
        body:JSON.stringify({
          model:"gpt-4o",
          messages: current.messages.map(m=>({
            role: m.role,
            content: m.role==="user"
              ? `${m.content}\n(نام: ${userName} | تاریخ: ${m.timestamp} | روز: ${day})`
              : m.content
          })).slice(-50)
        })
      });
      const data = await res.json();
      const aiText = data.choices[0].message.content;
      const aiTime = new Date().toLocaleString("fa-IR");

      current.messages.push({role:"assistant",content:aiText,timestamp:aiTime});
      if(current.messages.length>50) current.messages.shift();
      localStorage.setItem("chatSessions",JSON.stringify(sessions));
      appendMessage("bot",aiText);
    }

    document.getElementById("user-input")
      .addEventListener("keydown", e=>{
        if(e.key==="Enter" && !e.shiftKey){
          e.preventDefault();
          sendMessage();
        }
      });
  </script>
</body>
</html>
