<!DOCTYPE html>
<html lang="fa" dir="rtl">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>MAi – Gemini</title>
  <link rel="icon" href="/MAI.png" />
  <link rel="stylesheet" href="/styles.css" />
  <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
</head>
<body>
  <!-- نوار بالا -->
  <div class="navbar0">MAi</div>
  <div class="navbar1">Gemini</div>
  <div class="navbar2">
    <a href="/">خانه</a> |
    <a href="/sessions.html">گفتگوها</a> |
    <a href="/settings.html">تنظیمات</a>
  </div>

  <!-- فرم دریافت نام -->
  <div id="name-form" class="chat-container" style="text-align:center;">
    <h2>نام خود را وارد کنید</h2>
    <input type="text" id="name-input" placeholder="مثلاً احسان" style="padding:10px; width:80%; border-radius:5px;" />
    <br /><br />
    <button onclick="saveName()" class="send-button">شروع</button>
  </div>

  <!-- چت -->
  <div id="chat-section" class="chat-container" style="display:none;">
    <div id="chat-box"></div>
    <div class="input-container">
      <textarea id="user-input" placeholder="پیام خود را بنویسید..."></textarea>
      <button class="send-button" onclick="sendMessage()">
        <i class="arrow-up"></i>
      </button>
    </div>
  </div>

  <footer class="footer">
    <div class="footer-content">
      <p>&copy; <span id="year"></span> MAi – All rights reserved. <a href="https://ehsan-hashemi.ir" target="_blank">Ehsan Group</a></p>
    </div>
  </footer>

  <script>
    document.getElementById("year").textContent = new Date().getFullYear();

    let userName = localStorage.getItem("userName");
    if (userName) {
      document.getElementById("name-form").style.display = "none";
      document.getElementById("chat-section").style.display = "block";
    }

    function saveName() {
      const input = document.getElementById("name-input").value.trim();
      if (input) {
        localStorage.setItem("userName", input);
        location.reload();
      }
    }

    const weekDays = ["یکشنبه","دوشنبه","سه‌شنبه","چهارشنبه","پنجشنبه","جمعه","شنبه"];
    const apiUrl = "https://api.gapgpt.app/v1/chat/completions";
    const apiKey = "sk-KXYGZrOUDvivO5hmX0yrvCZBUJk1HYB4YuuHSl7C88Beou2Y";

    const urlParams = new URLSearchParams(window.location.search);
    let sessionId = urlParams.get("sessionId");
    const sessions = JSON.parse(localStorage.getItem("chatSessions") || "[]");
    let currentSession = sessions.find(s => s.id === sessionId);

    if (!currentSession) {
      sessionId = "session_" + Date.now();
      currentSession = {
        id: sessionId,
        name: localStorage.getItem("userName"),
        created: new Date().toLocaleString("fa-IR"),
        messages: []
      };
      sessions.push(currentSession);
      localStorage.setItem("chatSessions", JSON.stringify(sessions));
      window.history.replaceState(null, "", `?sessionId=${sessionId}`);
    }

    function appendMessage(sender, message) {
      const chatBox = document.getElementById("chat-box");
      const msgDiv = document.createElement("div");
      msgDiv.className = sender === "user" ? "message user-message" : "message bot-message";
      msgDiv.innerHTML = marked.parse(message);
      chatBox.appendChild(msgDiv);
      chatBox.scrollTop = chatBox.scrollHeight;
    }

    currentSession.messages.forEach(msg => {
      appendMessage(msg.role === "assistant" ? "bot" : "user", msg.content);
    });

    async function sendMessage() {
      const inputEl = document.getElementById("user-input");
      const text = inputEl.value.trim();
      if (!text) return;

      const now = new Date();
      const faDate = now.toLocaleString("fa-IR");
      const today = weekDays[now.getDay()];
      const enriched = `${text}\n\n(نام کاربر: ${userName} | تاریخ: ${faDate} | روز: ${today})`;

      currentSession.messages.push({ role: "user", content: text, timestamp: faDate });
      localStorage.setItem("chatSessions", JSON.stringify(sessions));
      appendMessage("user", text);
      inputEl.value = "";

      const response = await fetch(apiUrl, {
        method: "POST",
        headers: {
          "Content-Type": "application/json",
          Authorization: `Bearer ${apiKey}`
        },
        body: JSON.stringify({
          model: "gemini-2.5-pro",
          messages: currentSession.messages.slice(-100).map(m => ({
            role: m.role,
            content: m.role === "user"
              ? `${m.content}\n\n(نام کاربر: ${userName} | تاریخ: ${m.timestamp} | روز: ${today})`
              : m.content
          }))
        })
      });

      const data = await response.json();
      const aiText = data.choices[0].message.content;
      const aiTime = new Date().toLocaleString("fa-IR");

      currentSession.messages.push({ role: "assistant", content: aiText, timestamp: aiTime });
      localStorage.setItem("chatSessions", JSON.stringify(sessions));
      appendMessage("bot", aiText);
    }

    document.getElementById("user-input").addEventListener("keydown", e => {
      if (e.key === "Enter" && !e.shiftKey) {
        e.preventDefault();
        sendMessage();
      }
    });
  </script>
</body>
</html>
